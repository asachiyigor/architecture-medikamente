# Задание 4. Оценка узких мест при миграции системы «Медикаменте»

## 1. Анализ текущей ситуации

### Текущая система
Компания «Медикаменте» использует монолитную инфраструктуру на базе физического сервера с Windows Server 2022. Ключевые компоненты:
- **Excel-файлы** — основное хранилище данных пациентов, журналов приёма, медкарт, анализов
- **1С:Бухгалтерия** и **1С:Торговля и склад** — файловый режим работы
- **Active Directory / Exchange** — аутентификация и почта
- **ККМ** — интеграция через TCP/IP + OLE

### Цели миграции
- Переход на микросервисную архитектуру (Java, PostgreSQL, Kubernetes)
- Обеспечение 5-кратного масштабирования (новые филиалы)
- Внедрение клиентского портала и мобильного приложения
- Соответствие требованиям 152-ФЗ по защите ПДн

---

## 2. Выявленные узкие места (по категориям диаграммы Исикавы)

### 2.1 Инфраструктура

| Проблема | Описание | Влияние на миграцию | Приоритет |
|----------|----------|--------------------|----|
| **Единая точка отказа** | Один физический сервер для всех сервисов | Во время миграции любой сбой сервера останавливает всю работу компании. Невозможно развернуть новую систему параллельно. | Критический |
| **Отсутствие Kubernetes** | Нет контейнерной инфраструктуры | Необходимо развернуть кластер с нуля. Требуется время на настройку, тестирование, мониторинг. | Высокий |
| **Windows Server среда** | Текущая инфраструктура на Windows | Целевой стек (Java + PostgreSQL + K8s) требует Linux. Нужна миграция ОС или развёртывание нового оборудования / облака. | Высокий |
| **Сетевая сегментация** | Плоская сеть без разделения на зоны | Новые сервисы (клиентский портал) требуют DMZ, сегментации. Нет разделения между пациентскими данными и внутренними. | Средний |

### 2.2 Программное обеспечение

| Проблема | Описание | Влияние на миграцию | Приоритет |
|----------|----------|--------------------|----|
| **1С в файловом режиме** | 1С работает с файлами на диске, не поддерживает REST API | Невозможно масштабировать. Нужно мигрировать на серверный режим или заменить на новые сервисы. | Критический |
| **Excel как база данных** | Основные данные в Excel-файлах | Отсутствие схемы данных, валидации, транзакционности. Конвертация в PostgreSQL потребует ручной нормализации. | Критический |
| **OLE-интеграция** | Устаревший протокол взаимодействия | OLE не работает через сеть, не поддерживает современные стандарты. Нужна полная переделка интеграции с ККМ. | Высокий |
| **Отсутствие модульности** | Монолитная архитектура без чётких доменных границ | Сложно выделить независимые микросервисы. Требуется предварительное DDD-проектирование. | Средний |

### 2.3 Данные

| Проблема | Описание | Влияние на миграцию | Приоритет |
|----------|----------|--------------------|----|
| **Разнородность форматов** | Данные в Excel, JPG, PDF, 1С — нет единого формата | Каждый тип данных требует отдельного ETL-процесса. Высокий риск ошибок при конвертации. | Критический |
| **Дублирование данных** | Двойной учёт (Excel + 1С), дублирование медкарт | При миграции нужно определить «источник правды» для каждой записи, разрешить конфликты. | Высокий |
| **Отсутствие схемы** | Нет единой модели данных и справочников | Нужно спроектировать реляционную модель с нуля. Риск потери семантики при маппинге. | Высокий |
| **Потеря данных при конвертации** | Сканы и JPG содержат данные, не извлекаемые автоматически | Нужен процесс OCR или ручного ввода для оцифровки сканированных документов. | Средний |

### 2.4 Интеграция

| Проблема | Описание | Влияние на миграцию | Приоритет |
|----------|----------|--------------------|----|
| **Устаревший протокол ККМ** | TCP/IP + OLE — не поддерживает шифрование и мониторинг | Нужна замена на REST API или обновление ККМ с поддержкой современных протоколов. | Высокий |
| **Отсутствие API** | Системы не имеют API для взаимодействия | Невозможно постепенно переключать компоненты. Нужен anti-corruption layer. | Высокий |
| **Параллельная работа систем** | Во время миграции старая и новая системы работают одновременно | Синхронизация данных между старой и новой системами — основной риск. | Критический |

### 2.5 Персонал

| Проблема | Описание | Влияние на миграцию | Приоритет |
|----------|----------|--------------------|----|
| **Малочисленный IT-отдел** | 3 человека (техдир, сисадмин, аналитик) | Недостаточно ресурсов для параллельной разработки, тестирования и поддержки текущей системы. | Критический |
| **Нет опыта микросервисов** | Команда работала только с монолитом и 1С | Нужно обучение или наём специалистов с опытом Java/K8s/PostgreSQL. | Высокий |
| **Сопротивление изменениям** | 20+ сотрудников привыкли работать с Excel | Риск саботажа новой системы. Нужна программа обучения и change management. | Средний |

### 2.6 Процессы

| Проблема | Описание | Влияние на миграцию | Приоритет |
|----------|----------|--------------------|----|
| **Ручные процессы** | Все операции ручные — сложно автоматизировать поэтапно | Нужно параллельно менять и ПО, и бизнес-процессы. Увеличивается scope миграции. | Высокий |
| **Отсутствие CI/CD** | Нет конвейера для автоматического развёртывания | Нужно построить CI/CD pipeline с нуля. Без него — ручной деплой с высоким риском ошибок. | Средний |
| **Нет плана отката** | Нет DRP (Disaster Recovery Plan) | При сбое миграции нет способа быстро вернуться к предыдущему состоянию. | Критический |
| **Нет метрик** | Отсутствуют метрики для оценки успеха миграции | Невозможно объективно оценить прогресс и качество миграции. | Средний |

---

## 3. Рекомендации по устранению узких мест

### Приоритет: Критический (устранить до начала миграции)

| № | Мера | Ожидаемый результат | Ответственный |
|---|------|---------------------|---------------|
| 1 | **Развернуть дополнительный сервер / облачную инфраструктуру** | Устранение единой точки отказа. Возможность параллельного запуска новой системы. | Администратор сети |
| 2 | **Определить «источник правды» для каждого типа данных** | Ясная стратегия конвертации. Устранение дублирования. | Бизнес-аналитик + Техдиректор |
| 3 | **Разработать план отката (DRP)** | Возможность безопасного возврата к предыдущему состоянию при сбое. | Техдиректор |
| 4 | **Нанять 2-3 Java/DevOps разработчиков** | Достаточные ресурсы для параллельной разработки. | Руководство |
| 5 | **Разработать стратегию синхронизации данных** для периода параллельной работы | Минимизация рисков рассогласования данных. | Техдиректор |

### Приоритет: Высокий (устранить на первом этапе миграции)

| № | Мера | Ожидаемый результат | Ответственный |
|---|------|---------------------|---------------|
| 6 | **Развернуть Kubernetes-кластер** | Готовая платформа для микросервисов. | Администратор сети |
| 7 | **Спроектировать реляционную модель данных (DDD)** | Чёткие доменные границы и схемы для PostgreSQL. | Техдиректор + Аналитик |
| 8 | **Провести ETL-миграцию из Excel в PostgreSQL** | Данные в нормализованном формате с валидацией. | Аналитик + Разработчики |
| 9 | **Перевести 1С в серверный режим** | Масштабируемость, защищённость, возможность интеграции. | Администратор сети |
| 10 | **Построить CI/CD pipeline** (GitLab CI / GitHub Actions) | Автоматизация сборки, тестирования и деплоя. | DevOps-инженер |
| 11 | **Обучить персонал работе с новой системой** | Снижение сопротивления изменениям, уменьшение ошибок. | Аналитик |

### Приоритет: Средний (устранить на втором этапе)

| № | Мера | Ожидаемый результат | Ответственный |
|---|------|---------------------|---------------|
| 12 | **Внедрить мониторинг и метрики** (Victoria Metrics + Grafana) | Объективная оценка прогресса миграции. Раннее обнаружение проблем. | DevOps-инженер |
| 13 | **Сегментировать сеть** (DMZ для внешних сервисов) | Безопасная архитектура сети для клиентского портала. | Администратор сети |
| 14 | **Оцифровать сканированные документы** (OCR) | Перевод бумажных документов в структурированный формат. | Аналитик + Разработчики |
| 15 | **Заменить OLE-интеграцию ККМ на REST API** | Современный протокол с шифрованием и мониторингом. | Разработчики |

---

## 4. Метрики оценки успешности миграции

| Метрика | Описание | Целевое значение |
|---------|----------|-----------------|
| **Deployment Frequency** | Частота деплоев в продакшн | >= 1 раз в неделю |
| **Lead Time for Changes** | Время от коммита до продакшна | < 1 дня |
| **MTTR** (Mean Time to Recovery) | Среднее время восстановления после инцидента | < 1 часа |
| **Change Failure Rate** | Процент неудачных деплоев | < 15% |
| **Data Migration Accuracy** | Процент корректно мигрированных записей | > 99.9% |
| **System Availability** | Доступность системы во время миграции | > 99.5% |
| **User Adoption Rate** | Процент сотрудников, перешедших на новую систему | > 90% за 3 месяца |
