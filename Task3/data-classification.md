# Задание 3. Оценка Data Encryption at Rest and In Transit

## 1. Классификация данных

### 1.1 Категории данных по уровню чувствительности

| Уровень | Описание | Критерии отнесения |
|---------|----------|-------------------|
| **Критический (L4)** | Данные, утечка которых влечёт юридическую ответственность и максимальный ущерб | Врачебная тайна, данные аутентификации |
| **Высокий (L3)** | Персональные данные, защищённые 152-ФЗ | ПДн пациентов, платёжные данные, кадровые данные |
| **Средний (L2)** | Данные с ограниченным доступом | Контракты, бухгалтерская отчётность, внутренние документы |
| **Низкий (L1)** | Общедоступные внутри компании данные | Справочники, расписание, данные ТМЦ |

---

## 2. Реестр данных с обоснованием защиты и инструментами

| Данные | Состояние | Уровень | В чём необходимость защиты | Инструменты защиты |
|--------|-----------|---------|---------------------------|-------------------|
| **Медицинские карты** (диагнозы, анамнез, назначения) | At Rest | L4 (Критический) | Врачебная тайна (ст. 13 ФЗ-323). Утечка влечёт уголовную ответственность (ст. 137 УК РФ). Содержат PHI — защищённую медицинскую информацию. | Шифрование AES-256 на уровне столбцов БД (PostgreSQL pgcrypto); ABAC — доступ только у лечащего врача; полное логирование обращений; HSM для хранения ключей |
| **Медицинские карты** (передача между сервисами) | In Transit | L4 | Перехват данных в сети раскрывает врачебную тайну | TLS 1.3 для всех внутренних соединений; mTLS между микросервисами; VPN для удалённого доступа |
| **Результаты анализов** | At Rest | L4 (Критический) | PHI, врачебная тайна. Результаты анализов позволяют идентифицировать заболевания пациента. | Шифрование AES-256; хранение в отдельной БД с ABAC; обезличивание при передаче в аналитику |
| **Результаты анализов** (обмен с лабораторией) | In Transit | L4 | Передача третьей стороне — повышенный риск. Необходим контроль целостности. | mTLS для API лаборатории; подпись сообщений (HMAC); шифрование payload (JWE); журналирование всех обменов |
| **ПДн пациентов** (ФИО, дата рождения, телефон, email) | At Rest | L3 (Высокий) | 152-ФЗ обязывает защищать ПДн. Утечка ведёт к штрафам до 18 млн руб. и потере доверия клиентов. | Шифрование AES-256 (TDE PostgreSQL); RBAC; псевдонимизация для аналитики; динамическое маскирование при отображении |
| **ПДн пациентов** (ввод через портал) | In Transit | L3 | Данные передаются через интернет — риск перехвата | HTTPS (TLS 1.3); HSTS; Certificate Pinning в мобильном приложении |
| **СНИЛС, паспортные данные** | At Rest | L3 (Высокий) | Относятся к ПДн специальной категории. Позволяют совершить кражу личности. | Шифрование AES-256 на уровне полей; хранение отдельно от основных ПДн; токенизация; доступ только по необходимости (principle of least privilege) |
| **Платёжные данные** (суммы, реквизиты, чеки) | At Rest | L3 (Высокий) | Финансовая информация, привязанная к ПДн. Утечка ведёт к финансовому мошенничеству. | Токенизация платёжных реквизитов; шифрование AES-256; соответствие PCI DSS; маскирование при отображении |
| **Платёжные данные** (ККМ — сервер) | In Transit | L3 | Текущий канал TCP/IP без шифрования уязвим к MITM-атаке | TLS 1.3 для связи ККМ с сервером; замена OLE на REST API; сетевая сегментация |
| **Данные аутентификации** (логины, пароли, токены) | At Rest | L4 (Критический) | Компрометация учётных данных даёт полный доступ к системе | Хеширование паролей (Argon2id); ключи в HashiCorp Vault; ротация токенов; MFA |
| **Данные аутентификации** (сессии) | In Transit | L4 | Перехват токена даёт доступ к сессии пользователя | TLS 1.3; HttpOnly + Secure cookies; короткое время жизни токенов (15 мин); refresh token rotation |
| **Кадровые данные сотрудников** (ФИО, паспорт, ИНН, зарплата) | At Rest | L3 (Высокий) | ПДн сотрудников защищены 152-ФЗ. Утечка зарплатных данных — репутационный ущерб. | Шифрование AES-256; RBAC (только бухгалтерия); аудит обращений |
| **Контракты с пациентами** | At Rest | L2 (Средний) | Содержат ПДн и условия оказания услуг | Шифрование at rest (LUKS / TDE); RBAC; безопасное хранилище документов (S3 + server-side encryption) |
| **Бухгалтерская отчётность** (P&L, налоги) | At Rest | L2 (Средний) | Коммерческая тайна. Разглашение — конкурентный ущерб. | Шифрование at rest; RBAC (бухгалтерия + руководство); аудит |
| **Логи аудита** | At Rest | L2 (Средний) | Журналы содержат метаданные обращений. Манипуляция логами скрывает инциденты. | Append-only хранилище (Elasticsearch WORM); шифрование at rest; отдельный контроль доступа; ротация и архивирование |
| **Данные ТМЦ и складского учёта** | At Rest | L1 (Низкий) | Операционные данные без ПДн. Минимальный ущерб при утечке. | Шифрование at rest (TDE); базовый контроль доступа по ролям |
| **Расписание приёмов** (без ПДн) | At Rest | L1 (Низкий) | Не содержит ПДн в обезличенном виде | Контроль доступа; шифрование at rest |
| **Обезличенные аналитические данные** | At Rest | L1 (Низкий) | Данные уже обезличены, но требуют защиты от re-identification | k-анонимизация (k>=5); l-разнообразие; дифференциальная приватность; шифрование at rest |
| **Данные между микросервисами** | In Transit | L2-L4 | Внутренний трафик тоже должен быть защищён (Zero Trust) | mTLS между сервисами в Kubernetes (Istio service mesh); сетевые политики (NetworkPolicy); шифрование на уровне транспорта |

---

## 3. Базовые инструменты защиты

### 3.1 Шифрование At Rest

| Инструмент | Назначение | Применение в «Медикаменте» |
|------------|-----------|---------------------------|
| **PostgreSQL TDE (Transparent Data Encryption)** | Шифрование всей БД на уровне файловой системы | Основные базы: пациенты, медкарты, платежи |
| **pgcrypto (PostgreSQL extension)** | Шифрование на уровне отдельных столбцов | Критические поля: СНИЛС, диагнозы, паспортные данные |
| **LUKS (Linux Unified Key Setup)** | Шифрование дисков на уровне ОС | Все серверы и хранилища |
| **HashiCorp Vault** | Управление ключами шифрования, секретами, сертификатами | Централизованное управление ключами для всех сервисов |
| **MinIO Server-Side Encryption** | Шифрование объектов в S3-совместимом хранилище | Документы, сканы, контракты |

### 3.2 Шифрование In Transit

| Инструмент | Назначение | Применение в «Медикаменте» |
|------------|-----------|---------------------------|
| **TLS 1.3** | Шифрование HTTP-трафика | Все веб-порталы, API, внешние интеграции |
| **mTLS (Mutual TLS)** | Двусторонняя аутентификация сервисов | Связь между микросервисами; API лаборатории |
| **Istio Service Mesh** | mTLS в Kubernetes-кластере, сетевые политики | Внутрикластерные коммуникации |
| **WireGuard VPN** | Шифрованный туннель для удалённого доступа | Доступ из филиалов; удалённая работа |
| **SSH** | Безопасный доступ к серверам | Администрирование серверов |

### 3.3 Защита данных In Use

| Инструмент | Назначение | Применение в «Медикаменте» |
|------------|-----------|---------------------------|
| **Dynamic Data Masking (PostgreSQL)** | Маскирование данных при отображении | Показ ПДн для ролей без полного доступа |
| **Row-Level Security (PostgreSQL)** | Ограничение доступа к строкам на уровне БД | Пациент видит только свои данные |
| **Keycloak RBAC/ABAC** | Контроль доступа на уровне приложения | Разграничение доступа по ролям и атрибутам |
| **Application-level encryption** | Шифрование данных в оперативной памяти | Обработка критических медицинских данных |

---

## 4. Автоматизированный контроль

### 4.1 Средства мониторинга и контроля

| Средство | Назначение | Что контролирует |
|----------|-----------|-----------------|
| **ELK Stack (Elasticsearch + Logstash + Kibana)** | Централизованный сбор и анализ логов | Все обращения к данным; аутентификация; изменения прав доступа; ошибки шифрования |
| **Victoria Metrics + Grafana** | Мониторинг метрик и алертинг | Количество обращений к критическим данным; аномальные паттерны доступа; состояние сертификатов TLS; использование ресурсов |
| **OWASP ZAP / Trivy** | Сканирование уязвимостей | Автоматическая проверка API и контейнеров на уязвимости в CI/CD |
| **Open Policy Agent (OPA)** | Policy-as-Code | Автоматическая валидация политик доступа к данным при деплое |
| **cert-manager (Kubernetes)** | Управление сертификатами | Автоматическая ротация TLS-сертификатов |
| **Falco** | Runtime security | Обнаружение аномального поведения контейнеров и обращений к данным |

### 4.2 Автоматические проверки в CI/CD

| Этап | Проверка | Инструмент |
|------|----------|------------|
| Build | Сканирование зависимостей на уязвимости | Trivy, Snyk |
| Build | Проверка секретов в коде | GitLeaks, TruffleHog |
| Test | Проверка работы с тегированными данными | Интеграционные тесты + OPA |
| Deploy | Валидация сетевых политик | OPA / Kyverno |
| Runtime | Мониторинг доступа к критическим данным | Falco + ELK |

---

## 5. Реестр программных и аппаратных средств защиты данных

| Категория | Средство | Тип | Назначение | Лицензия |
|-----------|----------|-----|-----------|----------|
| **Шифрование** | PostgreSQL TDE / pgcrypto | Программное | Шифрование данных в БД | Open Source |
| **Шифрование** | HashiCorp Vault | Программное | Управление ключами и секретами | Open Source (BSL) |
| **Шифрование** | LUKS | Программное | Full-disk encryption | Open Source |
| **Транспорт** | TLS 1.3 (OpenSSL) | Программное | Шифрование сетевого трафика | Open Source |
| **Транспорт** | Istio Service Mesh | Программное | mTLS в Kubernetes | Open Source |
| **Транспорт** | WireGuard | Программное | VPN для филиалов | Open Source |
| **Контроль доступа** | Keycloak | Программное | IAM, SSO, MFA, RBAC/ABAC | Open Source |
| **Контроль доступа** | PostgreSQL RLS | Программное | Row-Level Security | Open Source |
| **Маскирование** | Dynamic Data Masking | Программное | Маскирование данных при чтении | PostgreSQL extension |
| **Тегирование** | Apache Atlas | Программное | Классификация и тегирование метаданных | Open Source |
| **Потоки данных** | Apache NiFi | Программное | ETL и контроль потоков данных | Open Source |
| **Мониторинг** | Victoria Metrics | Программное | Сбор и хранение метрик | Open Source |
| **Мониторинг** | Grafana | Программное | Визуализация метрик и алертинг | Open Source |
| **Логирование** | ELK Stack | Программное | Сбор, хранение и анализ логов | Open Source |
| **Безопасность** | Falco | Программное | Runtime security monitoring | Open Source |
| **Безопасность** | OPA | Программное | Policy-as-Code | Open Source |
| **CI/CD Security** | Trivy | Программное | Сканирование уязвимостей контейнеров | Open Source |
| **CI/CD Security** | GitLeaks | Программное | Обнаружение секретов в коде | Open Source |
| **Оркестрация** | Kubernetes | Программное | Оркестрация контейнеров, NetworkPolicy | Open Source |
| **Хранилище** | MinIO | Программное | S3-совместимое хранилище с SSE | Open Source |
| **Аппаратные** | HSM (при масштабировании) | Аппаратное | Аппаратное хранение ключей шифрования | Коммерческое |
| **Сетевые** | Firewall (iptables / nftables) | Программное | Сетевая фильтрация | Open Source |
