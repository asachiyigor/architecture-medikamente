# Задание 5. Разработка cutover-плана миграции «Медикаменте»

## 1. Обоснование выбора стратегии миграции

### Выбранная стратегия: Parallel Run (параллельный запуск)

### Почему Parallel Run?

Из трёх предложенных вариантов миграции для компании «Медикаменте» наиболее подходит стратегия **Parallel Run** — параллельный запуск старой и новой систем с постепенным переводом нагрузки.

**Обоснование:**

| Критерий | Parallel Run | High-Level Design | Branch by Abstraction |
|----------|-------------|-------------------|----------------------|
| **Непрерывность бизнеса** | Старая система работает как fallback — бизнес не останавливается | Требует значительного downtime при переключении | Постепенный переход, но сложная координация слоёв |
| **Безопасность данных** | Данные пациентов защищены — при сбое новой системы данные не теряются | Высокий риск при единовременном переключении | Умеренный риск — зависит от качества абстракций |
| **Проверяемость** | Можно сравнивать результаты работы обеих систем | Нельзя сравнить — старая система выключена | Частичная проверяемость |
| **Соответствие 152-ФЗ** | Миграция ПДн проверяется поэтапно, можно валидировать каждый шаг | Одномоментная миграция — риск нарушений | Риск утечек на стыке абстракций |
| **Сложность для команды** | Средняя — параллельная работа двух систем понятна | Низкая, но высокий риск | Высокая — требует опыта создания абстракций |
| **Подходит для медицины** | Да — критически важна доступность и целостность медданных | Нет — неприемлемый риск | Частично — зависит от реализации |

**Преимущества Parallel Run для «Медикаменте»:**
1. **Минимальный риск для пациентов** — медицинская клиника не может позволить себе простой. При параллельном запуске клиника продолжает работать на старой системе.
2. **Валидация данных** — можно сверять данные между старой и новой системами, обеспечивая 100% точность миграции.
3. **Постепенное обучение персонала** — сотрудники осваивают новую систему, имея возможность вернуться к старой.
4. **Соответствие регуляторным требованиям** — поэтапная верификация соблюдения 152-ФЗ.

**Ограничения:**
1. **Двойная нагрузка на инфраструктуру** — нужны ресурсы для работы обеих систем.
2. **Синхронизация данных** — необходимо обеспечить согласованность данных между системами.
3. **Двойной ввод данных** — на переходном этапе часть данных вводится в обе системы.
4. **Затраты** — поддержка двух систем одновременно увеличивает операционные расходы.

---

## 2. Cutover-план

### 2.1 Общая временная шкала

```
Месяц 1-2:   Подготовка (инфраструктура, команда, план)
Месяц 3-4:   MVP — портал записи + портал ресепшена
Месяц 5-6:   Интеграция платежей и CRM
Месяц 7-8:   Интеграция лаборатории + мобильное приложение
Месяц 9-10:  Аналитический слой (Data Lake) + BI
Месяц 11-12: Полный переход + вывод старой системы
```

### 2.2 Детальный план по этапам

| Этап | Описание действия | Ключевые задачи | Ответственные | Время/Сроки | Риски и меры по снижению |
|------|-------------------|-----------------|---------------|-------------|------------------------|
| **0. Подготовка** | Развёртывание инфраструктуры и формирование команды | 1. Развернуть Kubernetes-кластер (облако или дополнительный сервер). 2. Настроить CI/CD pipeline. 3. Нанять 2-3 разработчиков (Java/DevOps). 4. Спроектировать доменную модель данных (DDD). 5. Разработать план отката (DRP). 6. Настроить мониторинг (Victoria Metrics + Grafana). | Техдиректор, Администратор сети | Месяц 1-2 | **Риск:** Задержка найма. **Мера:** Начать поиск до старта проекта; рассмотреть подрядчиков. |
| **1. MVP — Запись на приём** | Параллельный запуск портала записи на приём | 1. Разработать клиентский портал (запись на приём). 2. Разработать портал ресепшена. 3. Развернуть Keycloak (IAM). 4. Мигрировать данные журнала записей из Excel в PostgreSQL. 5. Настроить Consent Management. 6. Параллельная работа: ресепшен продолжает работу в Excel, данные синхронизируются с новой БД. | Разработчики, Аналитик | Месяц 3-4 | **Риск:** Рассогласование данных при двойном вводе. **Мера:** Автоматическая синхронизация Excel → PostgreSQL через Apache NiFi; ежедневная сверка. |
| **2. Платежи и CRM** | Подключение платёжного шлюза и CRM | 1. Разработать платёжный шлюз с токенизацией. 2. Перевести 1С:Бухгалтерия в серверный режим. 3. Интегрировать платёжный шлюз с 1С через REST API. 4. Развернуть CRM-систему. 5. Мигрировать данные пациентов и контракты. 6. Отказаться от двойного учёта в Excel. | Разработчики, Бухгалтерия | Месяц 5-6 | **Риск:** Потеря платёжных данных при миграции. **Мера:** Валидация 100% записей после миграции; backup до начала. **Риск:** Несовместимость API 1С. **Мера:** Anti-corruption layer между новыми сервисами и 1С. |
| **3. Лаборатория и мобильное приложение** | Интеграция с лабораторией анализов, запуск моб. приложения | 1. Разработать Lab Integration API (REST + mTLS). 2. Мигрировать медицинские карты в PostgreSQL (ABAC + шифрование). 3. Разработать мобильное приложение (ЛК пациента). 4. Настроить push-уведомления и голосового робота. 5. Внедрить тегирование данных (Apache Atlas). | Разработчики, Медицинские специалисты | Месяц 7-8 | **Риск:** Медкарты содержат неструктурированные данные (сканы). **Мера:** OCR для оцифровки; ручная верификация критических записей. **Риск:** API лаборатории может не поддерживать mTLS. **Мера:** VPN-туннель как fallback. |
| **4. Аналитика** | Построение аналитического слоя | 1. Развернуть Data Lake (ClickHouse). 2. Настроить ETL-пайплайн (Apache NiFi). 3. Внедрить движок классификации данных. 4. Обезличить данные для аналитики (k-анонимизация). 5. Настроить BI-дашборды (Grafana/Superset). 6. Подготовить среду для ML/AI (Jupyter). | Аналитик, Разработчики | Месяц 9-10 | **Риск:** Некорректная классификация данных — ПДн попадают в аналитику. **Мера:** Автоматическое тегирование + ручная проверка Data Steward. |
| **5. Полный переход** | Отключение старой системы | 1. Финальная сверка данных (старая vs новая система). 2. Аудит безопасности всей новой системы. 3. Проверка соответствия 152-ФЗ. 4. Переключение всех пользователей на новую систему. 5. Мониторинг в режиме hypercare (2 недели). 6. Архивация и безопасное уничтожение данных старой системы. | Техдиректор, все отделы | Месяц 11-12 | **Риск:** Обнаружение критических багов после переключения. **Мера:** Plan B — возврат на старую систему в течение 4 часов (DRP). |

---

## 3. План отката (Rollback Plan)

### Стратегия отката по этапам

| Этап | Условие отката | Действия при откате | Время отката |
|------|---------------|--------------------|----|
| **MVP** | Критический баг в записи, потеря данных | Переключить трафик на старую систему. Ресепшен возвращается к Excel. | < 1 часа |
| **Платежи** | Сбой платёжного шлюза, потеря транзакций | Вернуть приём платежей через ККМ + ручной учёт. Восстановить данные из backup. | < 2 часов |
| **Медкарты** | Утечка медданных, нарушение ABAC | Заблокировать доступ к новой системе. Медспециалисты работают со сканами. Расследование инцидента. | < 4 часов |
| **Полный переход** | Массовый сбой новой системы | Развернуть старую систему из архива. Восстановить данные из последнего backup. Уведомить пациентов. | < 8 часов |

### Критерии для принятия решения об откате

- Потеря данных пациентов (любое количество записей)
- Доступность системы < 95% в течение 4 часов
- Утечка конфиденциальных данных
- Невозможность приёма платежей > 2 часов
- Невозможность записи пациентов > 1 часа в рабочее время

---

## 4. Распределение ролей

| Роль | Ответственный | Зона ответственности |
|------|---------------|---------------------|
| **Руководитель миграции** | Технический директор | Общая координация, принятие решений об откате, архитектурные решения |
| **DevOps-инженер** | Администратор сети (+ новый сотрудник) | Инфраструктура, CI/CD, Kubernetes, мониторинг |
| **Разработчики** | 2-3 новых сотрудника | Разработка микросервисов, API, порталов |
| **Data Engineer** | Бизнес-аналитик (+ обучение) | ETL, миграция данных, аналитический слой, валидация |
| **Data Steward / DPO** | Новая роль | Тегирование данных, проверка соответствия 152-ФЗ, аудит |
| **Change Manager** | Руководство | Обучение персонала, управление изменениями, коммуникация |
| **Тестировщик** | Разработчик + представители отделов | Приёмочное тестирование каждого этапа |

---

## 5. Управление рисками

### Матрица рисков

| Риск | Вероятность | Влияние | Стратегия | Конкретные меры |
|------|-------------|---------|-----------|----------------|
| **Потеря данных при миграции** | Средняя | Критическое | Предотвращение | Full backup до каждого этапа. Валидация 100% записей после миграции. Чек-суммы. |
| **Утечка ПДн при миграции** | Средняя | Критическое | Предотвращение | Шифрование данных в transit (TLS 1.3). Ограничение доступа к миграционным скриптам. Аудит. |
| **Рассогласование данных** (между старой и новой системой) | Высокая | Высокое | Снижение | Автоматическая синхронизация через Apache NiFi. Ежедневная сверка отчётов. Reconciliation dashboard. |
| **Нехватка ресурсов команды** | Высокая | Высокое | Снижение | Наём начать до проекта. Рассмотреть аутсорс для разработки порталов. |
| **Сопротивление персонала** | Средняя | Среднее | Снижение | Обучение до запуска каждого этапа. Менторство. Демонстрация преимуществ. Обратная связь. |
| **Downtime при переключении** | Средняя | Высокое | Снижение | Blue-green deployment. Переключение в нерабочие часы (воскресенье). DRP < 4 часов. |
| **Несовместимость API 1С** | Средняя | Среднее | Принятие | Anti-corruption layer. Адаптеры для каждой версии 1С. |
| **Производительность новой системы** ниже ожиданий | Низкая | Среднее | Снижение | Нагрузочное тестирование до каждого этапа. Мониторинг в реальном времени. Автоскейлинг в K8s. |

### Ключевые контрольные точки (Gates)

| Gate | Критерии перехода к следующему этапу |
|------|-------------------------------------|
| **Gate 0 → 1** | K8s-кластер развёрнут. CI/CD работает. Команда укомплектована. DRP утверждён. |
| **Gate 1 → 2** | MVP работает стабильно 2 недели. Данные записей синхронизированы. Пользователи обучены. |
| **Gate 2 → 3** | Платежи проходят через новый шлюз. 1С в серверном режиме. Excel-учёт платежей отключён. |
| **Gate 3 → 4** | API лаборатории работает. Медкарты в PostgreSQL. Мобильное приложение прошло приёмку. |
| **Gate 4 → 5** | Аналитика работает на обезличенных данных. Нет ПДн в аналитическом слое. BI-дашборды проверены. |
| **Gate 5 → Завершение** | Все данные мигрированы и сверены. Аудит 152-ФЗ пройден. Hypercare 2 недели без инцидентов. |
